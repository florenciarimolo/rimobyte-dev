---
import MainLayout from '@/layouts/MainLayout.astro';
import MigrationLandingPage from '@/components/MigrationLandingPage';
import MigrationStructuredData from '@/components/migration-landing/MigrationStructuredData.astro';
import { LANG, getI18N } from '@/i18n/index';
import { SITE_URL } from '@/constants';
import { isValidCityForLang, getCityInfo, indexableCities, internationalCities } from '@/constants/cities';

const { city } = Astro.params;

// Validate city - must be lowercase and valid for English language (Spanish + international cities)
const normalizedCity = city?.toLowerCase();
const isValidCity = normalizedCity && isValidCityForLang(normalizedCity, 'en');

if (!isValidCity) {
  return Astro.redirect('/404');
}

const cityInfo = getCityInfo(normalizedCity!);
const cityName = cityInfo!.name;
const isInternational = normalizedCity! in internationalCities;
const isIndexable = indexableCities.includes(normalizedCity!);

const locale = LANG.ENGLISH;
const translations = getI18N({ currentLocale: locale });

const currentUrl = `${SITE_URL}${Astro.url.pathname}`;
const title = `${translations.migrationLanding.hero.title} in ${cityName} | RimoByte`;
const description = isInternational 
  ? (translations.migrationLanding.hero as any).localSeoInternational?.replace('{city}', cityName) || translations.migrationLanding.hero.localSeo.replace('{city}', cityName)
  : translations.migrationLanding.hero.localSeo.replace('{city}', cityName);
---

<MainLayout 
  title={title}
  description={description}
  locale={locale}
  city={cityName}
>
  <meta name="robots" content={isIndexable ? "index, follow" : "noindex, follow"} />
  
  <MigrationStructuredData 
    url={currentUrl}
    city={cityName}
    cityInfo={cityInfo}
    locale={locale}
  />
  <MigrationLandingPage 
    client:only="react" 
    cityName={cityName}
    cityInfo={cityInfo}
    recaptchaSiteKey={import.meta.env.RECAPTCHA_SITE_KEY || '6LeIxAcTAAAAAJcZVRqyHh71UMIEGNQ_MXjiZKhI'}
    initialLocale={locale}
  />
</MainLayout>
