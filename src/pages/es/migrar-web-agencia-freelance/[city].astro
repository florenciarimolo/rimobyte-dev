---
import MainLayout from '@/layouts/MainLayout.astro';
import MigrationLandingPage from '@/components/MigrationLandingPage';
import MigrationStructuredData from '@/components/migration-landing/MigrationStructuredData.astro';
import { LANG, getI18N } from '@/i18n/index';
import { SITE_URL } from '@/constants';
import { isValidCityForLang, getCityInfo, indexableCities, getAllowedCities } from '@/constants/cities';

export function getStaticPaths() {
  const cities = getAllowedCities('es');
  return Object.keys(cities).map((city) => ({ params: { city } }));
}

const { city } = Astro.params;

// Validate city - must be lowercase and valid for Spanish language
const normalizedCity = city?.toLowerCase();
const isValidCity = normalizedCity && isValidCityForLang(normalizedCity, 'es');

if (!isValidCity) {
  return Astro.redirect('/404');
}

const cityInfo = getCityInfo(normalizedCity!);
const cityName = cityInfo!.name;
const isIndexable = indexableCities.includes(normalizedCity!);

const locale = LANG.SPANISH;
const translations = getI18N({ currentLocale: locale });

const currentUrl = `${SITE_URL}${Astro.url.pathname}`;
const title = `Migraci√≥n y rescate de webs WordPress en ${cityName} | RimoByte`;
const description = translations.migrationLanding.hero.localSeo.replace('{city}', cityName);
---

<MainLayout 
  title={title}
  description={description}
  locale={locale}
  city={cityName}
>
  <meta name="robots" content={isIndexable ? "index, follow" : "noindex, follow"} />
  
  <MigrationStructuredData 
    url={currentUrl}
    city={cityName}
    cityInfo={cityInfo}
    locale={locale}
  />
  <MigrationLandingPage 
    client:only="react" 
    cityName={cityName}
    cityInfo={cityInfo}
    recaptchaSiteKey={import.meta.env.RECAPTCHA_SITE_KEY || '6LeIxAcTAAAAAJcZVRqyHh71UMIEGNQ_MXjiZKhI'}
    initialLocale={locale}
  />
</MainLayout>
